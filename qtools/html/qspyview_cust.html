<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QTools: Customizing  and Extending QSpyView</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="ql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a id="logo" title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com"></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">QTools
   &#160;<span id="projectnumber">6.8.0</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)"
               onblur="searchBox.OnSearchFieldFocus(false)"
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;"
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('qspyview_cust.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0"
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Customizing and Extending QSpyView </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#qspyview_files">QSpyView files</a></li>
<li class="level1"><a href="#qspyview_script">Your Customization Script</a><ul><li class="level2"><a href="#qspyview_cust_commands">Adding Custom Commands</a></li>
<li class="level2"><a href="#qspyview_cust_menu">Additional Menu Options</a></li>
<li class="level2"><a href="#qspyview_cust_canvas">Custom Canvas (HMI)</a></li>
<li class="level2"><a href="#qspyview_cust_user">User Record Handlers</a></li>
<li class="level2"><a href="#qspyview_cust_special">Special Record Handlers</a></li>
<li class="level2"><a href="#qspyview_cust_standard">Standard Record Handlers</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>The <b>QSpyView</b> Front-End has been specifically designed for extensibility, so that you can quickly customize its behavior to your specific project. In fact, as mentioned in the section about <a class="el" href="qspyview.html#qspyview_run">running QSpyView</a>, the <span class="img file_wish">qspyview.tcl</span> script takes a command-line parameter, which is another Tcl script designed specifically to extend and customize the basic functionality. This section describes how to write this extension script, so that you can turn QSpyView into a powerful custom Human-Machine Interface (HMI) for your projects.</p>
<dl class="section note"><dt>Note</dt><dd>You don't need to change the <span class="img file_wish">qspyview.tcl</span> script to customize and extend it for your project. The customization you make go into a separate script, which is specific to your project. That way, you can have many different customization scripts and you don't pollute (and possibly break) the original code.</dd></dl>
<hr  />
 <h1><a class="anchor" id="qspyview_files"></a>
QSpyView files</h1>
<p>The QSpyView Front-End has a modular source code, consisting of the following files and folders:</p>
<ul class="tag">
<li>
<span class="img folder">qtools</span>  <ul class="tag">
<li>
<span class="img folder">qspy</span> &mdash; <a class="el" href="qspy.html">QSPY tool</a>  <ul class="tag">
<li>
<span class="img folder">qspyview</span> &mdash; <a class="el" href="qspyview.html">QSpyView</a> sources  <ul class="tag">
<li>
<span class="img folder">img</span> &mdash; images used by QSpyView&trade;  </li>
<li>
<span class="img file_tcl">qspy.tcl</span> &mdash; Tcl script for UDP communication with the QSPY Back-End  </li>
<li>
<span class="img file_wish">qspyview.tcl</span> &mdash; QSpyView Tcl/Tk script  </li>
<li>
<span class="img file_wish">default.tcl</span> &mdash; the default customization of the QSpyView Tcl/Tk script  </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>As you can see, the QSpyView source code is broken down into three scripts. The <span class="img file_tcl">qspy.tcl</span> script implements the UDP communication with the QSPY Back-End. This script is specifically written in pure Tcl an <b>no</b> Tk, so that it can be used both with and without a GUI (head-less scripts). This script is not standalone but rather it needs to be included (<code>source</code>ed) in other scripts.</p>
<p>The main functionality of QSpyView is implemented in the <span class="img file_wish">qspyview.tcl</span> script, which uses Tk for the GUI. This script takes up to three optional command-line parameters: <code>&lt;cust-script&gt;</code>, <code>&lt;qspy-host&gt;</code>, and <code>&lt;qspy-UDP-port&gt;</code>. The <code>&lt;cust-script&gt;</code> the customization script that will be included (<code>source</code>ed) by <code>qspyview.tcl</code>. If you don't provide this parameter, the default customization script <span class="img file_wish">default.tcl</span> will be used.</p>
<dl class="section note"><dt>Note</dt><dd>The QSpyView folder does <b>not</b> contain the customization for the DPP example application, because it makes much more sense to co-locate this customization with the DPP project. Consequently, the <span class="img file_wish">dpp.tcl</span> is located in the QP/C/C++ example directory <code>&lt;qpx&gt;\examples\arm-cm\dpp_ek-tm4c123gxl\qspy</code>, where <code>&lt;qpx&gt;</code> stands for QP/C or QP/C++ installation directory on your machine.</dd></dl>
<hr  />
 <h1><a class="anchor" id="qspyview_script"></a>
Your Customization Script</h1>
<p>The easiest way to customize QSpyView is to copy the provided <span class="img file_wish">default.tcl</span> script (or the <span class="img file_wish">dpp.tcl</span> example), rename it, and add your own extensions.</p>
<p>When you open <span class="img file_wish">default.tcl</span>, you will see that it consists of the following sections:</p>
<ul>
<li><a class="el" href="qspyview_cust.html#qspyview_cust_commands">command handlers</a> are Tcl procedures for your custom commands</li>
<li><a class="el" href="qspyview_cust.html#qspyview_cust_menu">additional menu options</a> are your own menu items added to the <a class="el" href="qspyview_ui.html">top-level menu</a></li>
<li><a class="el" href="qspyview_cust.html#qspyview_cust_canvas">custom canvas</a> for your project, where you can provide the User Interface for your project</li>
<li><a class="el" href="qspyview_cust.html#qspyview_cust_user">user record handlers</a> are Tcl procedures for handling application-specific (User) trace records</li>
<li><a class="el" href="qspyview_cust.html#qspyview_cust_special">special record handlers</a> are Tcl procedures to handle special trace records (RESET and Target INFO)</li>
<li><a class="el" href="qspyview_cust.html#qspyview_cust_standard">standard record handlers</a> are Tcl procedures to handle standard QS records from the Target</li>
</ul>
<div class="separate"></div> <h2><a class="anchor" id="qspyview_cust_commands"></a>
Adding Custom Commands</h2>
<p>Custom commands can come in two forms: commands with and without user-supplied parameters. A command without parameter can be simply coded as a Tcl procedure, which will be <a class="el" href="qspyview_cust.html#qspyview_cust_menu">attached to a menu item</a>. A command requiring user-supplied input needs to be implemented as a dialog box. The qspyview.tcl script provides plenty of examples of such dialog boxes.</p>
<p>A command procedure typically will end with <b>sending a packet</b> to the Target or to the QSPY Back-End. The qspy.tcl script provides the procedure <code>::qspy::sendPkt</code> for this purpose. Please refer to the example code (default.tcl or dpp.tcl) for examples of sending packets.</p>
<div class="separate"></div> <h2><a class="anchor" id="qspyview_cust_menu"></a>
Additional Menu Options</h2>
<p>Menu options can be added very simply. For example, the following line of Tcl adds the menu option "MyCommand" to the menu bar <code>.mber.cust</code>, which will call the procedure <code>onMyCommand</code>:</p>
<pre class="fragment">.mbar.cust add command -label "MyCommand" -command onMyCommand
</pre><div class="separate"></div> <h2><a class="anchor" id="qspyview_cust_canvas"></a>
Custom Canvas (HMI)</h2>
<p>The Canvas view can provide a complete custom Human-Machine Interface (HMI) to your embedded Target. The Canvas can display the changing status of the application and also it can provide <b>actuators</b> to control the Target.</p>
<div class="image">
<img src="qspyview_canv_dpp.gif" alt=""/>
<div class="caption">
Custom Canvas for the DPP Application</div></div>
<p>The screen shot above shows the Canvas customization from the <span class="img file_wish">dpp.tcl</span> script. Please note that the button in the center of the screen allows you to interact with the Target by sending commands to it. Please refer to this script code for the details of how various effects have been achieved.</p>
<dl class="section note"><dt>Note</dt><dd>Many Tk widget packages and libraries (e.g. BWidgets, IWidgets, etc.) are available to aid you in developing your custom canvas. With such widget libraries, you can display the data in an attractive form: as gauges, bars, graphs, and sliders. The attractiveness of the GUI is limited only by your creativity.</dd></dl>
<div class="separate"></div> <h2><a class="anchor" id="qspyview_cust_user"></a>
User Record Handlers</h2>
<p>The User trace records are the application-specific trace records that are produced by your embedded application (as opposed to the QP framework). These trace records very likely require custom handling, because QSPY cannot really "know" what they represent.</p>
<p>The DPP project provides two examples of User trace records (<code>PHILO_STAT</code> and <code>COMMAND_STAT</code>, see <code>bsp.c</code> in the <code>qpc\examples\arm-cm\dpp_ek-tm4c123gxl\qk</code> directory). The following picture shows the structure of the <code>PHILO_STAT</code> trace record:</p>
<div class="image">
<img src="qspy9.gif" alt=""/>
<div class="caption">
PHILO_STAT User trace record</div></div>
<p>As all trace records, user records start with the sequence number, followed by the record-ID. However, you should also known that all user records contain a time-stamp and that all data fields are preceded by a format-byte. This format byte helps QSPY to correctly display all data fields, but is really unnecessary for you, who knows the layout of the data.) As a concrete example, here is the complete User record handler for <code>PHILO_STAT == QS_USER + 0 == 70</code>:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment"># user record handlers [70..0x7C] --------------------------------------------</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"></span><span class="keyword">proc</span> ::qspy::rec70  {} { ;<span class="comment"># QS_USER</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"></span><span class="comment">    </span><span class="keyword">variable</span> thePkt<span class="comment"></span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"></span>    <span class="keyword">variable</span> theFmt<span class="comment"></span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"></span>    <span class="keyword">binary</span> scan $thePkt xx$theFmt(tstamp)xcxa* \</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;           tstamp philoNum stat<span class="comment"></span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    dispTxt [<span class="keyword">format</span> &quot;%010u Philo %1d is %s&quot; $tstamp $philoNum $stat<span class="comment"></span>]<span class="comment"></span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    <span class="keyword">global</span> thePhiloId<span class="comment"></span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"></span>    <span class="keyword">set</span> img [<span class="keyword">string</span> index $stat 0<span class="comment"></span>]<span class="comment"></span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"></span>    .canv.c itemconfigure [<span class="keyword">expr</span> $thePhiloId + $philoNum<span class="comment"></span>] -image ::img::$img<span class="comment"></span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"></span><span class="comment"></span>}<span class="comment"></span></div>
</div><!-- fragment --><ul class="tag">
<li>
<p class="startli"><span class="tag">line 2</span> The record-handler procedure is always starts with <code>proc ::qspy::rec&lt;num&gt; {}</code>, where <code>&lt;num&gt;</code> is the trace record number in decimal. The procedure takes no parameters. </p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><span class="tag">line 3</span> The packet content is provided as variable <code>$thePkt</code>. </p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><span class="tag">line 4</span> The formats of QSPY objects are provided as the (associative) array <code>$theFmt</code>. You will need the format of time-stamp to parse the User packet. </p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><span class="tag">lines 5-6</span> The parsing of the packet is accomplished by the <code>binary scan</code> Tcl command. The meaning of the format fields is as follows: <code>x</code> skip sequence number, <code>x</code> skip record-ID, <code>$theFmt(timestamp)</code> extract the specified number of bytes and assign to the local variable <code>tstamp</code>, <code>x</code> skip the format byte, <code>c</code> extract a byte and assign to the local variable <code>philoNum</code>, <code>x</code> skip the format byte, <code>a*</code> extract a zero-terminated string and assign to local variable <code>stat</code>. </p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><span class="tag">line 8</span> the <code>dispTxt</code> command (implemented in qspyview.tcl) displays the specified string in the <a class="el" href="qspyview_ui.html">text view</a>. </p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><span class="tag">line 12</span> the Canvas is updated with the new image of the "Philosopher", which reflects its current status. This accomplishes animation of the images on the Canvas. </p>
<p class="endli"></p>
</li>
</ul>
<div class="separate"></div> <h2><a class="anchor" id="qspyview_cust_special"></a>
Special Record Handlers</h2>
<p>The custom script offers you an option to add your own customization for the special events, such as Reset of the Target and the arrival of the Target INFO. You can add your code inside the following procedures:</p>
<pre class="fragment">proc ::qspy::recRESET {} { ;# target reset callback
}
proc ::qspy::recINFO  {} { ;# target info callback
}
</pre><div class="separate"></div> <h2><a class="anchor" id="qspyview_cust_standard"></a>
Standard Record Handlers</h2>
<p>As mentioned before, the QSpyView Front-End receives <b>all</b> trace records produced by the Target. This includes all standard QS records (see <a class="el" href="qs__copy_8h.html#acdb495c1e5524b5d95aaff82c47f6db5" title="Quantum Spy record types.">QSpyRecords</a>). All these record-handler procedures have the general form:</p>
<pre class="fragment">proc ::qspy::rec&lt;num&gt; {}
</pre><p>where <code>&lt;num&gt;</code> is a decimal trace record number in the range 1..69.</p>
<dl class="section note"><dt>Note</dt><dd>In order to parse the standard QS trace records, you could view the <code>qspy.c</code> implementation, where all the standard trace records are parsed and displayed to the screen.</dd></dl>
<hr  />
<p><b>Next:</b> <a class="el" href="history.html">Revision History</a></p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; Quantum Leaps 2020</a> &nbsp;| &nbsp; <a title="help" href="help.html">Using Online Help</a>&nbsp;| &nbsp;<a title="Doxygen" href="http://www.doxygen.nl">Generated with Doxygen</a>&nbsp; | &nbsp;<b>QTools 6.8.0</b>
    </li>
  </ul>
</div>
</body>
</html>
